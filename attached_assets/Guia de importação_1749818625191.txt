# Guia de Importação - Deploy Rota Caiçara para VPS

# Pré-requisitos
- VPS Ubuntu 22.04 LTS configurada
- Acesso root via SSH
- Domínio apontado para o IP da VPS

# Processo de Deploy

1. Acessar VPS via SSH
   
   ssh root@SEU_IP_VPS
   

2. Atualizar sistema operacional
   
   apt update && apt upgrade -y
   
   (Aceitar reinicialização de serviços quando solicitado)

3. Instalar dependências básicas
   
   apt install -y git nginx ufw curl wget
   

4. Instalar Node.js 20
   
   curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
   apt install -y nodejs
   

5. Verificar instalação do Node.js
   
   node --version
   npm --version
   

6. Configurar firewall
   
   ufw allow ssh
   ufw allow 80
   ufw allow 443
   ufw enable
   
   (Confirmar com 'y' quando solicitado)

7. Navegar para diretório web
   
   cd /var/www
   

8. Clonar repositório do projeto
   
   git clone https://github.com/workspacemrqz/rotacaicara.git
   cd rotacaicara
   

9. Instalar dependências do projeto
   
   npm install
   

10. Criar arquivo de ambiente
    
    nano .env
    
    Colar conteúdo:
    
    SESSION_SECRET=H5xK+M8kdvqOZC1inQVrVhkfIJvaCLgsNtECq8CyZrX0gcUjLuEVild3OGyMjTGlITPUpftb6iGjVKLncddv1g==
    PGUSER=neondb_owner
    PGPASSWORD=npg_e6aj7VwFLIuG
    DATABASE_URL=postgresql://neondb_owner:npg_e6aj7VwFLIuG@ep-damp-dust-adl2amrw.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require
    PGDATABASE=neondb
    PGHOST=ep-damp-dust-adl2amrw.c-2.us-east-1.aws.neon.tech
    PGPORT=5432
    REPL_ID=rotacaicara
    ISSUER_URL=https://replit.com/oidc
    REPLIT_DOMAINS=rotacaicara.com.br,www.rotacaicara.com.br
    
    Salvar: Ctrl+X, Y, Enter

11. Executar migrações do banco (forçado)
    
    npm run db:push -- --force
    

12. Compilar projeto para produção
    
    npm run build
    

13. Verificar existência dos arquivos compilados
    
    ls -la dist/
    

14. Instalar PM2 globalmente
    
    npm install -g pm2
    

15. Criar arquivo de configuração PM2
    
    nano ecosystem.config.json
    
    Colar conteúdo:
    
    {
      "apps": [{
        "name": "rotacaicara",
        "script": "node",
        "args": "dist/index.js",
        "cwd": "/var/www/rotacaicara",
        "env": {
          "NODE_ENV": "production",
          "SESSION_SECRET": "H5xK+M8kdvqOZC1inQVrVhkfIJvaCLgsNtECq8CyZrX0gcUjLuEVild3OGyMjTGlITPUpftb6iGjVKLncddv1g==",
          "PGUSER": "neondb_owner",
          "PGPASSWORD": "npg_e6aj7VwFLIuG",
          "DATABASE_URL": "postgresql://neondb_owner:npg_e6aj7VwFLIuG@ep-damp-dust-adl2amrw.c-2.us-east-1.aws.neon.tech/neondb?sslmode=require",
          "PGDATABASE": "neondb",
          "PGHOST": "ep-damp-dust-adl2amrw.c-2.us-east-1.aws.neon.tech",
          "PGPORT": "5432",
          "REPL_ID": "rotacaicara",
          "ISSUER_URL": "https://replit.com/oidc",
          "REPLIT_DOMAINS": "rotacaicara.com.br,www.rotacaicara.com.br"
        }
      }]
    }
    
    Salvar: Ctrl+X, Y, Enter

16. Testar aplicação manualmente
    
    export $(cat .env | xargs) && node dist/index.js
    
    (Deve exibir "serving on port 3002", pressionar Ctrl+C para parar)

17. Iniciar aplicação com PM2
    
    pm2 start ecosystem.config.json
    pm2 save
    pm2 startup
    

18. Verificar status da aplicação
    
    pm2 status
    pm2 logs rotacaicara --lines 10
    

19. Configurar Nginx como proxy reverso
    
    nano /etc/nginx/sites-available/rotacaicara
    
    Colar conteúdo:
    
    server {
        listen 80;
        server_name rotacaicara.com.br www.rotacaicara.com.br;

        location / {
            proxy_pass http://localhost:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }
    }
    
    Salvar: Ctrl+X, Y, Enter

20. Ativar configuração do Nginx
    
    ln -s /etc/nginx/sites-available/rotacaicara /etc/nginx/sites-enabled/
    rm /etc/nginx/sites-enabled/default
    nginx -t
    systemctl reload nginx
    

21. Instalar certificado SSL
    
    apt install snapd
    snap install core; snap refresh core
    snap install --classic certbot
    ln -s /snap/bin/certbot /usr/bin/certbot
    

22. Configurar HTTPS com Let's Encrypt
    
    certbot --nginx -d rotacaicara.com.br -d www.rotacaicara.com.br
    
    (Fornecer email, aceitar termos, confirmar compartilhamento opcional)

23. Reiniciar PM2 para estabilizar conexão
    
    pm2 restart rotacaicara
    

24. Testar conectividade final
    
    curl -I https://rotacaicara.com.br
    

# Checklist Final

## Antes de executar nova importação:
- [ ] VPS com Ubuntu 22.04 LTS configurada
- [ ] Domínio DNS apontado corretamente para IP da VPS
- [ ] Credenciais do banco Neon atualizadas no arquivo .env
- [ ] Repositório GitHub com código mais recente
- [ ] Backup dos dados existentes (se aplicável)

## Verificações críticas pós-deploy:
- [ ] PM2 status mostra aplicação "online"
- [ ] Logs do PM2 sem erros críticos (pm2 logs rotacaicara)
- [ ] Nginx funcionando (systemctl status nginx)
- [ ] Site acessível via HTTPS
- [ ] SSL válido e funcionando
- [ ] Conexão com banco de dados estabelecida
- [ ] Admin panel acessível (/admin)

## Comandos de manutenção:

# Verificar status
pm2 status
pm2 logs rotacaicara

# Atualizar código
cd /var/www/rotacaicara
git pull
npm run build
pm2 restart rotacaicara

# Verificar serviços
systemctl status nginx
systemctl status pm2-root


## Portas utilizadas:
- 3002: Aplicação Node.js (interno)
- 80: HTTP (redirecionado para HTTPS)
- 443: HTTPS (público)
- 22: SSH (administrativo)

## Arquivos importantes:
- /var/www/rotacaicara/.env (variáveis de ambiente)
- /var/www/rotacaicara/ecosystem.config.json (configuração PM2)
- /etc/nginx/sites-available/rotacaicara (configuração Nginx)
- /etc/letsencrypt/live/rotacaicara.com.br/ (certificados SSL)